<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
            <title>Show drawn polygon area</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        </style>
    </head>
    <body>
        <style>
            .calculation-box {
                height: 75px;
                width: 150px;
                position: absolute;
                bottom: 40px;
                left: 10px;
                background-color: rgba(255, 255, 255, 0.9);
                padding: 15px;
                text-align: center;
            }
            
            p {
                font-family: 'Open Sans';
                margin: 0;
                font-size: 13px;
            }
        </style>
        
        <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js"></script>
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.js"></script>
        <link
        rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.css"
        type="text/css"
        />
        <div id="map"></div>
            <div class="calculation-box">
                <p>Draw a polygon using the draw tools.</p>
            <div id="calculated-area"></div>
        </div>

        <div id="submit"></div>
            <div class="submit-box">
                <p>Click here to submit the data.</p>
            <div id="submit-area"></div>
        </div>

        <script>

            function pathplanning(sourceElem, destElem, sourceLang, destLang) {
                        $(destElem).html('<img src="{{ url_for('static', filename='loading.gif') }}">');
                        $.post('/pathplanning', {
                            start_waypoint: sourceElem,
                            end_waypoint: sourceLang,
                            polygon: destLang
                        }).done(function(response) {
                            $(destElem).text(response['text'])
                        }).fail(function() {
                            $(destElem).text("{{ _('Error: Could not contact server.') }}");
                        });
                    }

            mapboxgl.accessToken = 'pk.eyJ1Ijoiam9zdWVoZmEiLCJhIjoiY2tldnNnODB3MDBtdDJzbXUxMXowMTY5MyJ9.Vwj9BTqB1z9RLKlyh70RHw';
            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/satellite-v9', //hosted style id
                center: [-91.874, 42.76], // starting position
                zoom: 12 // starting zoom
                });
            
            var draw = new MapboxDraw({
                displayControlsDefault: false,
                controls: {
                polygon: true,
                trash: true
                }
                });
            map.addControl(draw);
            
            map.on('draw.create', updateArea);
            map.on('draw.delete', updateArea);
            map.on('draw.update', updateArea);
            
            function updateArea(e) {
                var data = draw.getAll();
                var answer = document.getElementById('calculated-area');
                if (data.features.length > 0) {
                    var area = turf.area(data);
                    // restrict to area to 2 decimal points
                    var rounded_area = Math.round(area * 100) / 100;
                    answer.innerHTML =
                    rounded_area ;
                } else {
                    answer.innerHTML = '';
                    if (e.type !== 'draw.delete')
                        alert('Use the draw tools to draw a polygon!');
                }
            }

            $('#calculated-area').click(function() {
                    var data = draw.getAll();
                    $.ajax({
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    url: "/pathplanning",
                    traditional: "true",
                    data: JSON.stringify({data}),
                    dataType: "json"
                    });
                });

            map.on('load', function () {
                map.addSource('route', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [
                                [-122.48369693756104, 37.83381888486939],
                                [-122.48348236083984, 37.83317489144141],
                                [-122.48339653015138, 37.83270036637107],
                                [-122.48356819152832, 37.832056363179625],
                                [-122.48404026031496, 37.83114119107971],
                                [-122.48404026031496, 37.83049717427869],
                                [-122.48348236083984, 37.829920943955045],
                                [-122.48356819152832, 37.82954808664175],
                                [-122.48507022857666, 37.82944639795659],
                                [-122.48610019683838, 37.82880236636284],
                                [-122.48695850372314, 37.82931081282506],
                                [-122.48700141906738, 37.83080223556934],
                                [-122.48751640319824, 37.83168351665737],
                                [-122.48803138732912, 37.832158048267786],
                                [-122.48888969421387, 37.83297152392784],
                                [-122.48987674713133, 37.83263257682617],
                                [-122.49043464660643, 37.832937629287755],
                                [-122.49125003814696, 37.832429207817725],
                                [-122.49163627624512, 37.832564787218985],
                                [-122.49223709106445, 37.83337825839438],
                                [-122.49378204345702, 37.83368330777276]
                                ]
                            }
                        }
                });

                map.addLayer({
                    'id': 'route',
                    'type': 'line',
                    'source': 'route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#888',
                        'line-width': 8
                    }
                });
            });
        </script>
    
    </body>
</html>

